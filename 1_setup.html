<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Improved Touch Controls - Phaser Platformer series</title>
    <script src="js/phaser.min.js"></script>
    <link rel="stylesheet" href="css/screen.css" />
  </head>

  <body>
    <script type="text/javascript">
      var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 400,
        transparent: true,
        physics: {
          default: "arcade",
          arcade: {
            fps: 120,
            gravity: { y: 300 },
          },
        },
        scene: {
          preload: preload,
          create: create,
          update: update,
        },
      };

      var player,
        coins,
        platforms,
        cursors,
        score = 0,
        scoreText,
        acceleration = 600,
        jumpVelocity = -330,
        wasStanding = false,
        edgeTimer = 0,
        jumping = false,
        prevPos = 0,
        yPos = 0,
        touchJump = false,
        touchJumpThreshold = 5,
        touchSlider,
        sliderBar,
        sliderKnob,
        touchMoving = false,
        touchMoveThreshold = 3,
        largeThumbMoveAcross = 25,
        thumbSizeOffset = 60,
        startX,
        onLadder = false,
        ladders;

      var game = new Phaser.Game(config);

      function preload() {
        this.load.setBaseURL("assets/");
        this.load.image("ground", "platform.jpg");
        this.load.image("coin", "coin.jpg");
        this.load.image("hero", "hero.jpg");
        this.load.image("logo", "digitherium-logo.jpg");
        this.load.image("touch-slider", "touch-slider.png");
        this.load.image("touch-knob", "touch-knob.png");
        this.load.image("baddie", "baddie.jpg");
        this.load.image("ladder", "ladder.png");
      }

      function create() {
        var logo = this.add.sprite(config.width / 2, config.height / 2, "logo");
        logo.alpha = 0.4;
        logo.setScale(0.5);

        this.input.addPointer(1);
        platforms = this.physics.add.staticGroup();

        platforms.create(400, 400, "ground").setScale(2).refreshBody();
        platforms.create(50, 240, "ground");
        platforms.create(750, 140, "ground");

        player = this.physics.add.sprite(100, 350, "hero");

        player.setCollideWorldBounds(true);

        player.setBounce(0);

        player.body.maxVelocity.x = 200;
        player.body.maxVelocity.y = 500;

        cursors = this.input.keyboard.createCursorKeys();

        coins = this.physics.add.group({
          key: "coin",
          repeat: 11,
          setXY: { x: 12, y: 0, stepX: 70 },
        });

        coins.children.iterate(function (child) {
          child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
        });

        scoreText = this.add.text(46, 16, "0", {
          fontSize: "32px",
          fill: "#fff",
        });

        baddie = this.physics.add.sprite(620, 350, "baddie");
        baddie.setOrigin(0.5, 0.5);
        baddie.setCollideWorldBounds(true);
        baddie.body.velocity.x = -100;
        baddie.maxDistance = 300;
        baddie.previousX = baddie.x;
        this.physics.add.collider(baddie, platforms);

        ladders = this.physics.add.staticGroup();
        ladders.enableBody = true;
        ladder = ladders.create(268, 296, "ladder");
        ladder.body.immovable = true;
        this.physics.add.overlap(player, ladders, isOnLadder, null, this);

        scoreCoin = this.add.sprite(30, 32, "coin");
        scoreCoin.setOrigin(0.5, 0.5);
        scoreCoin.scaleX = 0.5;
        scoreCoin.scaleY = 0.5;
        this.physics.add.collider(player, platforms);
        this.physics.add.collider(coins, platforms);
        this.physics.add.overlap(player, coins, collectCoin, null, this);
        this.physics.add.overlap(player, baddie, hitBaddie, null, this);
        buildTouchSlider(this);
      }
      function isOnLadder() {
        onLadder = true;
        player.body.setAllowGravity(false);
      }

      function hitBaddie(player, baddie) {
        if (baddie.body.touching.up) {
          baddie.disableBody(false, false);

          player.setVelocityY(jumpVelocity);

          var tween = this.tweens.add({
            targets: baddie,
            alpha: 0.3,
            scaleX: 1.5,
            scaleY: 1.5,
            ease: "Linear",
            duration: 200,
            onComplete: function () {
              destroyGameObject(baddie);
            },
          });
        } else {
          player.disableBody(false, false);

          var tween = this.tweens.add({
            targets: player,
            alpha: 0.3,
            scaleX: 1.1,
            scaleY: 1.1,
            angle: 90,
            x: player.x - 20,
            y: player.y - 20,
            ease: "Linear",
            duration: 200,
            onComplete: function () {
              restartGame(this);
            },
            onCompleteScope: this,
          });
        }
      }
      function restartGame(game) {
        game.scene.restart();
      }
      function buildTouchSlider(game) {
        sliderBar = game.add.sprite(0, 0, "touch-slider");
        sliderKnob = game.add.sprite(0, 0, "touch-knob");

        touchSlider = game.add.container(100, 450);
        touchSlider.add(sliderBar);
        touchSlider.add(sliderKnob);
        touchSlider.alpha = 0;
      }

      function moveLeft(acceleration) {
        var standing = player.body.blocked.down || player.body.touching.down;

        if (standing) {
          player.setAccelerationX(-acceleration);
        } else {
          player.setAccelerationX(-acceleration / 3);
        }
      }

      function moveRight(acceleration) {
        var standing = player.body.blocked.down || player.body.touching.down;

        if (standing) {
          player.setAccelerationX(acceleration);
        } else {
          player.setAccelerationX(acceleration / 3);
        }
      }
      function switchDirection(baddie) {
        baddie.body.velocity.x *= -1;

        baddie.previousX = baddie.x;
      }

      function update() {
        var standing = player.body.blocked.down || player.body.touching.down;
        if (Math.abs(baddie.x - baddie.previousX) >= baddie.maxDistance) {
          switchDirection(baddie);
        }
        if (cursors.left.isDown) {
          moveLeft(acceleration);
        } else if (cursors.right.isDown) {
          moveRight(acceleration);
        }

        if (this.input.pointer1.isDown || this.input.pointer2.isDown) {
          var leftHalf = config.width / 2;
          if (
            this.input.pointer1.x < leftHalf ||
            this.input.pointer2.x < leftHalf
          ) {
            var myMovePointer = null;

            if (
              this.input.pointer1.x < leftHalf &&
              this.input.pointer1.isDown
            ) {
              myMovePointer = this.input.pointer1;
            }
            if (
              this.input.pointer2.x < leftHalf &&
              this.input.pointer2.isDown
            ) {
              myMovePointer = this.input.pointer2;
            }

            if (myMovePointer) {
              if (!touchSlider.alpha) {
                touchSlider.alpha = 1;

                touchSlider.x = myMovePointer.x;

                touchSlider.y = myMovePointer.y - thumbSizeOffset;

                startX = myMovePointer.x;
                sliderKnob.x = 0;
              }

              if (myMovePointer.x < startX || myMovePointer.x > startX) {
                var movement = 0;
                if (myMovePointer.x < startX)
                  movement = startX - myMovePointer.x;
                if (myMovePointer.x > startX)
                  movement = myMovePointer.x - startX;

                if (movement > touchMoveThreshold) {
                  touchMoving = true;
                  var isTouch = true;
                  var sliderPos = 0;

                  if (myMovePointer.x < startX)
                    sliderPos = -(sliderBar.width / 4);

                  if (myMovePointer.x > startX) sliderPos = sliderBar.width / 4;

                  var tmpAcceleration = acceleration / 8;

                  if (movement > largeThumbMoveAcross) {
                    if (myMovePointer.x < startX)
                      sliderPos = -(sliderBar.width / 2);
                    if (myMovePointer.x > startX)
                      sliderPos = sliderBar.width / 2;

                    tmpAcceleration = acceleration;
                  }

                  var tween = this.tweens.add({
                    targets: sliderKnob,
                    x: sliderPos,
                    ease: "Power1",
                    duration: 300,
                  });
                  if (myMovePointer.x < startX) moveLeft(tmpAcceleration);
                  if (myMovePointer.x > startX) moveRight(tmpAcceleration);
                } else {
                  touchMoving = false;

                  var tween = this.tweens.add({
                    targets: sliderKnob,
                    x: 0,
                    ease: "Power1",
                    duration: 300,
                  });
                }
              }
            }
          }

          if (
            this.input.pointer1.x > leftHalf ||
            this.input.pointer2.x > leftHalf
          ) {
            var myJumpPointer = null;

            if (
              this.input.pointer1.x > leftHalf &&
              this.input.pointer1.isDown
            ) {
              myJumpPointer = this.input.pointer1;
            }
            if (
              this.input.pointer2.x > leftHalf &&
              this.input.pointer2.isDown
            ) {
              myJumpPointer = this.input.pointer2;
            }

            if (myJumpPointer) {
              prevPos = yPos;

              yPos = myJumpPointer.y;
              if (onLadder) {
                player.setVelocityY(0);
                if (Math.floor(prevPos) > Math.floor(yPos)) {
                  if (!myMovePointer) {
                    player.x = ladder.x;
                    player.setVelocityX(0);
                    player.setVelocityY(-100);
                  }
                }
                if (Math.floor(prevPos) < Math.floor(yPos)) {
                  if (!myMovePointer) {
                    player.x = ladder.x;
                    player.setVelocityX(0);
                    player.setVelocityY(100);
                  }
                }
              } else {
                if (prevPos - yPos > touchJumpThreshold) {
                  touchJump = true;
                }
              }
            }
          }
        } else {
          touchSlider.alpha = 0;
          startX = 0;
          touchMoving = false;
          if (onLadder) {
            player.setVelocityY(0);
          }
        }
       
        if (!cursors.right.isDown && !cursors.left.isDown && !touchMoving) {
          if (
            Math.abs(player.body.velocity.x) < 10 &&
            Math.abs(player.body.velocity.x) > -10
          ) {
            player.setVelocityX(0);
            player.setAccelerationX(0);
          } else {
            player.setAccelerationX(
              ((player.body.velocity.x > 0 ? -1 : 1) * acceleration) / 3
            );
          }
        }

        var d = new Date();
        var time = d.getTime();
        if (onLadder && !isTouch) {
    //kill any upwards / downwards velocity from our hero
    player.setVelocityY(0);

    if (cursors.up.isDown) {
        if (!cursors.left.isDown && !cursors.right.isDown) {
            //when moving vertically we want the player pefectly lined up
            player.x = ladder.x;
            //also kill any x velocity to be sure
            player.setVelocityX(0);
            player.setVelocityY(-100);
        }
    }
    //if JUST down is being pressed then line up player perfectly with ladder. 
    //We do this to make it quicker - but like a firemans pole
    if (cursors.down.isDown && !cursors.left.isDown && !cursors.right.isDown) {
        //when moving vertically we want the player pefectly lined up
        player.x = ladder.x;
        //also kill any x velocity to be sure
        player.setVelocityX(0);
        player.setVelocityY(100);
    }
}
        if (!standing && wasStanding) {
          edgeTimer = time + 100;
        }

        if (
          (standing || time <= edgeTimer) &&
          (cursors.up.isDown || touchJump) &&
          !jumping
        ) {
          player.setVelocityY(jumpVelocity);
          jumping = true;
        }

        if (!cursors.up.isDown) {
          if (player.body.touching.down) {
            jumping = false;
            touchJump = false;
            prevPos = 0;
          }
        }
        wasStanding = standing;
        if (!onLadder) player.body.setAllowGravity(true);
        onLadder = false;
      }

      function collectCoin(player, coin) {
        coin.disableBody(true, true);

        score += 10;
        scoreText.setText("Score: " + score);
        var tween = this.tweens.add({
          targets: coin,
          alpha: 0.3,
          angle: 720,
          x: scoreCoin.x,
          y: scoreCoin.y,
          scaleX: 0.5,
          scaleY: 0.5,
          ease: "Linear",
          duration: 500,
          onComplete: function () {
            destroyGameObject(coin);
          },
        });
        var scoreCoinTimeline = this.tweens.timeline({
          targets: scoreCoin,
          duration: 100,
          tweens: [
            {
              scaleX: 0.8,
              scaleY: 0.8,
              angle: "+=45",
            },
            {
              scaleX: 0.5,
              scaleY: 0.5,
              angle: "+=45",
            },
          ],
        });
      }
      function destroyGameObject(gameObject) {
        gameObject.destroy();
      }
    </script>
  </body>
</html>
